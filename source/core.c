#include "type.h"
#include "core.h"

/******************************************************************************
 * 
 * CONSTANTS
 *
 ******************************************************************************/

#define FLAG_CARRY  0x01

#define FLAG_SIGN   0x80

#define FLAG_PARITY 0x00

#define FLAG_ZERO   0x40

#define BRANCH_P    0x01

#define BRANCH_N    0x00

#define INTERRUPT_P 0x01

#define INTERRUPT_N 0x00

/******************************************************************************
 * 
 * MACRO
 *
 ******************************************************************************/

#define FN(N) I ## N

/******************************************************************************
 * 
 * TYPE DEFINITIONS
 *
 ******************************************************************************/

typedef struct
{
  u08 L;
  u08 H;
} word;

typedef union
{
  u16  R16;
  word R08;
} pair;

typedef struct
{
  pair AF;
  pair BC;
  pair DE;
  pair HL;
  pair SP;
  pair PC;
  pair WZ;

  u08 OP;
  
  u08 e;

  u08 branch;
  
  u08 interrupt;

  u08 port; /* memory mapped port */

} core;

/******************************************************************************
 * 
 * FILE SCOPE VARIABLES
 *
 ******************************************************************************/

static nil (* f_instruction [0x100]) (core *);

static u08 * f_memory = 0;

static u32   f_cycles = 0;

/******************************************************************************
 * 
 * TABLES
 *
 ******************************************************************************/

static u08 f_parity [] =
  {
    1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1,
    0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0,
    0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0,
    1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1,
    0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0,
    1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1,
    1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1,
    0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0,
    0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0,
    1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1,
    1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1,
    0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0,
    1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1,
    0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0,
    0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0,
    1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1,
  };

static u08 f_cycle [] [0x100] =
{
  {
     4, 10,  7,  5,  5,  5,  7,  4,  4, 10,  7,  5,  5,  5, 7,  4,
     4, 10,  7,  5,  5,  5,  7,  4,  4, 10,  7,  5,  5,  5, 7,  4,
     4, 10, 16,  5,  5,  5,  7,  4,  4, 10, 16,  5,  5,  5, 7,  4,
     4, 10, 13,  5, 10, 10, 10,  4,  4, 10, 13,  5,  5,  5, 7,  4,
     5,  5,  5,  5,  5,  5,  7,  5,  5,  5,  5,  5,  5,  5, 7,  5,
     5,  5,  5,  5,  5,  5,  7,  5,  5,  5,  5,  5,  5,  5, 7,  5,
     5,  5,  5,  5,  5,  5,  7,  5,  5,  5,  5,  5,  5,  5, 7,  5,
     7,  7,  7,  7,  7,  7,  7,  5,  5,  5,  5,  5,  5,  5, 7,  5,
     4,  4,  4,  4,  4,  4,  7,  4,  4,  4,  4,  4,  4,  4, 7,  4,
     4,  4,  4,  4,  4,  4,  7,  4,  4,  4,  4,  4,  4,  4, 7,  4,
     4,  4,  4,  4,  4,  4,  7,  4,  4,  4,  4,  4,  4,  4, 7,  4,
     4,  4,  4,  4,  4,  4,  7,  4,  4,  4,  4,  4,  4,  4, 7,  4,
    11, 10, 10, 10, 17, 11,  7, 11, 11, 10, 10, 10, 17, 17, 7, 11,
    11, 10, 10, 10, 17, 11,  7, 11, 11, 10, 10, 10, 17, 17, 7, 11,
    11, 10, 10, 18, 17, 11,  7, 11, 11,  5, 10,  5, 17, 17, 7, 11,
    11, 10, 10,  4, 17, 11,  7, 11, 11,  5, 10,  4, 17, 17, 7, 11
  }, {
     4, 10,  7,  5,  5,  5,  7,  4,  4, 10,  7,  5,  5,  5, 7,  4,
     4, 10,  7,  5,  5,  5,  7,  4,  4, 10,  7,  5,  5,  5, 7,  4,
     4, 10, 16,  5,  5,  5,  7,  4,  4, 10, 16,  5,  5,  5, 7,  4,
     4, 10, 13,  5, 10, 10, 10,  4,  4, 10, 13,  5,  5,  5, 7,  4,
     5,  5,  5,  5,  5,  5,  7,  5,  5,  5,  5,  5,  5,  5, 7,  5,
     5,  5,  5,  5,  5,  5,  7,  5,  5,  5,  5,  5,  5,  5, 7,  5,
     5,  5,  5,  5,  5,  5,  7,  5,  5,  5,  5,  5,  5,  5, 7,  5,
     7,  7,  7,  7,  7,  7,  7,  5,  5,  5,  5,  5,  5,  5, 7,  5,
     4,  4,  4,  4,  4,  4,  7,  4,  4,  4,  4,  4,  4,  4, 7,  4,
     4,  4,  4,  4,  4,  4,  7,  4,  4,  4,  4,  4,  4,  4, 7,  4,
     4,  4,  4,  4,  4,  4,  7,  4,  4,  4,  4,  4,  4,  4, 7,  4,
     4,  4,  4,  4,  4,  4,  7,  4,  4,  4,  4,  4,  4,  4, 7,  4,
     5, 10, 10, 10, 11, 11,  7, 11,  5, 10, 10, 10, 11, 17, 7, 11,
     5, 10, 10, 10, 11, 11,  7, 11,  5, 10, 10, 10, 11, 17, 7, 11,
     5, 10, 10, 18, 11, 11,  7, 11,  5,  5, 10,  5, 11, 17, 7, 11,
     5, 10, 10,  4, 11, 11,  7, 11,  5,  5, 10,  4, 11, 17, 7, 11
  }
};

static u08 f_port_o [0x101];

static u08 f_port_i [0x101];

/******************************************************************************
 * 
 * ARITHMETICS
 *
 ******************************************************************************/

static u08 f_rebuild_flags (core * c, u16 value)
{
  c->AF.R08.H = 0;

  if (! value)
    {
      c->AF.R08.H |= 0x40;

      return (u08) value;
    }
  
  if (f_parity [(u08) value])
    {
      c->AF.R08.H |= 0x04;
    }

  if (value & 0x80)
    {
      c->AF.R08.H |= 0x80;
    }

  if (value > 0xFF)
    {
      c->AF.R08.H |= 0x01;
    }

  if ((value & 0x0F) > 0x09)
    {
      c->AF.R08.H |= 0x10;
    }

  if ((value & 0xF0) > 0x90)
    {
      c->AF.R08.H |= 0x10;
    }

  return (u08) value;
}

static nil arithmetics_add (core * c, u08 value)
{
  c->AF.R08.L = f_rebuild_flags (c, c->AF.R08.L + value);
}

static nil arithmetics_adc (core * c, u08 value)
{
  if (c->AF.R08.H & 0x01)
    {
      c->AF.R08.L += f_rebuild_flags (c, c->AF.R08.L + value + 1);
    }
  else
    {
      c->AF.R08.L += f_rebuild_flags (c, c->AF.R08.L + value);      
    }
}

static nil arithmetics_sub (core * c, u08 value)
{
  c->AF.R08.L = f_rebuild_flags (c, c->AF.R08.L - value);
}

static nil arithmetics_sbb (core * c, u08 value)
{
  if (c->AF.R08.H & 0x01)
    {
      c->AF.R08.L += f_rebuild_flags (c, c->AF.R08.L - value + 1);
    }
  else
    {
      c->AF.R08.L += f_rebuild_flags (c, c->AF.R08.L - value);
    }
}

static nil arithmetics_ana (core * c, u08 value)
{
  c->AF.R08.L = f_rebuild_flags (c, c->AF.R08.L & value);
}

static nil arithmetics_xra (core * c, u08 value)
{
  c->AF.R08.L = f_rebuild_flags (c, c->AF.R08.L ^ value);
}

static nil arithmetics_ora (core * c, u08 value)
{
  c->AF.R08.L = f_rebuild_flags (c, c->AF.R08.L | value);
} 

static nil arithmetics_cmp (core * c, u08 value)
{
  f_rebuild_flags (c, c->AF.R08.L - value);
}

static nil arithmetics_ral (core * c, u08 value)
{
  if (c->AF.R08.H & 0x01)
  {
    if (c->AF.R08.L & 0x80)
    {
      c->AF.R08.L *= 0x02;
      c->AF.R08.L += 0x01;
    }
    else
    {
      c->AF.R08.L *= 0x02;
      c->AF.R08.L += 0x01;
      c->AF.R08.H &= 0xFE;
    }
  }
  else
  {
    if (c->AF.R08.L & 0x80)
    {
      c->AF.R08.L *= 0x02;
      c->AF.R08.H |= 0x01;
    }
    else
    {
      c->AF.R08.L *= 0x02;
    }
  }
}

static nil arithmetics_rlc (core * c, u08 value)
{
  if (c->AF.R08.L & 0x80)
  {
    c->AF.R08.L *= 0x02;
    c->AF.R08.L += 0x01;
    c->AF.R08.H |= 0x01;
  }
  else
  {
    c->AF.R08.L *= 0x02;

    if (c->AF.R08.L & 0x01)
    {
      c->AF.R08.L &= 0xFE;
    }
  }
}

static nil arithmetics_rar (core * c, u08 value)
{
  if (c->AF.R08.H & 0x01)
    {
      if (c->AF.R08.L & 0x01)
	{	  
	  c->AF.R08.L /= 0x02;
	  c->AF.R08.L += 0x80;
	}
      else
	{
	  c->AF.R08.L /= 0x02;
	  c->AF.R08.L += 0x80;
	  c->AF.R08.H &= 0xFE;
	}
    }
  else
    {
      if (c->AF.R08.L & 0x01)
	{
	  c->AF.R08.L /= 0x02;
	  c->AF.R08.H |= 0x01;
	}
      else
	{
	  c->AF.R08.L /= 0x02;
	}
    }
}

static nil arithmetics_rrc (core * c, u08 value)
{
  if (c->AF.R08.L & 0x01)
    {
      c->AF.R08.L /= 0x02;
      c->AF.R08.L += 0x80;
      c->AF.R08.H |= 0x01;
    }
  else
    {
      c->AF.R08.L /= 0x02;

      if (c->AF.R08.L & 0x01)
	{
	  c->AF.R08.L &= 0xFE;
	}
    }
}

static nil arithmetics_daa (core * c, u08 value)
{
  if (! (c->AF.R08.H & 0x10))
    {
      return;
    }

  c->AF.R08.H -= 0x10;
  
  if ((c->AF.R08.L & 0x0F) > 0x09)
    {
      c->AF.R08.L = f_rebuild_flags (c, c->AF.R08.L + 0x06);
    }

  if ((c->AF.R08.L & 0xF0) > 0x90)
    {
      c->AF.R08.L = f_rebuild_flags (c, c->AF.R08.L + 0x60);
    }
}

static nil arithmetics_cma (core * c, u08 value)
{
  c->AF.R08.L = ~ c->AF.R08.L;
}

static nil arithmetics_stc (core * c, u08 value)
{
  c->AF.R08.H |= 0x01;
}

static nil arithmetics_cmc (core * c, u08 value)
{
  if (c->AF.R08.H & 0x01)
    {
      c->AF.R08.H &= 0xFE;
    }
  else
    {
      c->AF.R08.H |= 0x01;
    }
}

static nil (* f_arithmetics []) (core *, u08) =
{
  arithmetics_add, arithmetics_adc, arithmetics_sub, arithmetics_sbb,
  arithmetics_ana, arithmetics_xra, arithmetics_ora, arithmetics_cmp,
  arithmetics_ral, arithmetics_rlc, arithmetics_rar, arithmetics_rrc,
  arithmetics_daa, arithmetics_cma, arithmetics_stc, arithmetics_cmc
};

/*******************************************************************************
 * 
 * NOP
 *
 ******************************************************************************/

static nil FN (00) (core * c)
{
  return;
}

/*******************************************************************************
 * 
 * LXI BC, word
 *
 ******************************************************************************/

static nil FN (01) (core * c)
{
  c->BC.R08.L = f_memory [++ c->PC.R16];
  c->BC.R08.H = f_memory [++ c->PC.R16];
}

/*******************************************************************************
 * 
 * STAX B
 *
 ******************************************************************************/

static nil FN (02) (core * c)
{
  f_memory [c->BC.R16] = c->AF.R08.L;
}

/*******************************************************************************
 * 
 * INX B
 *
 ******************************************************************************/

static nil FN (03) (core * c)
{
  ++ c->BC.R16;
}

/*******************************************************************************
 * 
 * INR b
 *
 ******************************************************************************/

static nil FN (04) (core * c)
{
  ++ c->BC.R08.L;
}

/*******************************************************************************
 * 
 * DCR b
 *
 ******************************************************************************/

static nil FN (05) (core * c)
{
  -- c->BC.R08.L;
}

/*******************************************************************************
 * 
 * MVI b, byte
 *
 ******************************************************************************/

static nil FN (06) (core * c)
{
  c->BC.R08.L = f_memory [++ c->PC.R16];
}

/*******************************************************************************
 * 
 * RLC
 *
 ******************************************************************************/

static nil FN (07) (core * c)
{
  f_arithmetics [0x9] (c, 1);
}

/*******************************************************************************
 * 
 * NOP
 *
 ******************************************************************************/

static nil FN (08) (core * c)
{
  
}

/*******************************************************************************
 * 
 * DAD B
 *
 ******************************************************************************/

static nil FN (09) (core * c)
{
  c->HL.R16 += c->BC.R16;
}

/*******************************************************************************
 * 
 * LDAX B
 *
 ******************************************************************************/

static nil FN (0A) (core * c)
{
  c->AF.R08.L = f_memory [c->BC.R16];
}

/*******************************************************************************
 * 
 * DCX B
 *
 ******************************************************************************/

static nil FN (0B) (core * c)
{
  -- c->BC.R16;
}

/*******************************************************************************
 * 
 * INX C
 *
 ******************************************************************************/

static nil FN (0C) (core * c)
{
  ++ c->BC.R08.H;
}

/*******************************************************************************
 * 
 * DCR C
 *
 ******************************************************************************/

static nil FN (0D) (core * c)
{
  -- c->BC.R08.H;
}

/*******************************************************************************
 * 
 * MVI c, byte
 *
 ******************************************************************************/

static nil FN (0E) (core * c)
{
  c->BC.R08.H = f_memory [++ c->PC.R16];
}

/*******************************************************************************
 * 
 * RRC
 *
 ******************************************************************************/

static nil FN (0F) (core * c)
{
  f_arithmetics [0xB] (c, 1);
}

/*******************************************************************************
 * 
 * NOP
 *
 ******************************************************************************/

static nil FN (10) (core * c)
{
  
}

/*******************************************************************************
 * 
 * LXI DE, word
 *
 ******************************************************************************/

static nil FN (11) (core * c)
{
  c->DE.R08.L = f_memory [++ c->PC.R16];
  c->DE.R08.H = f_memory [++ c->PC.R16];
}

/*******************************************************************************
 * 
 * STAX D
 *
 ******************************************************************************/

static nil FN (12) (core * c)
{
  f_memory [c->DE.R16] = c->AF.R08.L;
}

/*******************************************************************************
 * 
 * INX D
 *
 ******************************************************************************/

static nil FN (13) (core * c)
{
  ++ c->DE.R16;
}

/*******************************************************************************
 * 
 * INR d
 *
 ******************************************************************************/

static nil FN (14) (core * c)
{
  ++ c->DE.R08.L;
}

/*******************************************************************************
 * 
 * DCR D
 *
 ******************************************************************************/

static nil FN (15) (core * c)
{
  -- c->DE.R08.L;
}

/*******************************************************************************
 * 
 * MVI D, byte
 *
 ******************************************************************************/

static nil FN (16) (core * c)
{
  c->DE.R08.L = f_memory [++ c->PC.R16];
}

/*******************************************************************************
 * 
 * RAL
 *
 ******************************************************************************/

static nil FN (17) (core * c)
{
  f_arithmetics [0x8] (c, 1);
}

/*******************************************************************************
 * 
 * NOP
 *
 ******************************************************************************/

static nil FN (18) (core * c)
{
  
}

/*******************************************************************************
 * 
 * DAD D
 *
 ******************************************************************************/

static nil FN (19) (core * c)
{
  c->HL.R16 += c->DE.R16;
}

/*******************************************************************************
 * 
 * LDAX D
 *
 ******************************************************************************/

static nil FN (1A) (core * c)
{
  c->AF.R08.L = f_memory [c->DE.R16];
}

/*******************************************************************************
 * 
 * DCX D
 *
 ******************************************************************************/

static nil FN (1B) (core * c)
{
  -- c->DE.R16;
}

/*******************************************************************************
 * 
 * INR E
 *
 ******************************************************************************/

static nil FN (1C) (core * c)
{
  ++ c->DE.R08.H;
}

/*******************************************************************************
 * 
 * DCR E
 *
 ******************************************************************************/

static nil FN (1D) (core * c)
{
  -- c->DE.R08.H;
}

/*******************************************************************************
 * 
 * MVI e, byte
 *
 ******************************************************************************/

static nil FN (1E) (core * c)
{
  c->DE.R08.H = f_memory [++ c->PC.R16];
}

/*******************************************************************************
 * 
 * RAR
 *
 ******************************************************************************/

static nil FN (1F) (core * c)
{
  f_arithmetics [0xA] (c, 1);
}

/*******************************************************************************
 * 
 * NOP
 *
 ******************************************************************************/

static nil FN (20) (core * c)
{
  
}

/*******************************************************************************
 * 
 * LXI H, word
 *
 ******************************************************************************/

static nil FN (21) (core * c)
{
  c->HL.R08.L = f_memory [++ c->PC.R16];
  c->HL.R08.H = f_memory [++ c->PC.R16];
}

/*******************************************************************************
 * 
 * SHLD
 *
 ******************************************************************************/

static nil FN (22) (core * c)
{
  c->WZ.R08.L            = f_memory [++ c->PC.R16];
  c->WZ.R08.H            = f_memory [++ c->PC.R16];
  
  f_memory [c->WZ.R16    ] = c->HL.R08.L;
  f_memory [c->WZ.R16 + 1] = c->HL.R08.H;
}

/*******************************************************************************
 * 
 * INX H
 *
 ******************************************************************************/

static nil FN (23) (core * c)
{
  ++ c->HL.R16;
}

/*******************************************************************************
 * 
 * INR h
 *
 ******************************************************************************/

static nil FN (24) (core * c)
{
  ++ c->HL.R08.H;
}

/*******************************************************************************
 * 
 * DCR h
 *
 ******************************************************************************/

static nil FN (25) (core * c)
{
  -- c->HL.R08.H;
}

/*******************************************************************************
 * 
 * MVI h, byte
 *
 ******************************************************************************/

static nil FN (26) (core * c)
{
  c->HL.R08.H = f_memory [++ c->PC.R16];
}

/*******************************************************************************
 * 
 * DAA
 *
 ******************************************************************************/

static nil FN (27) (core * c)
{
  f_arithmetics [0xC] (c, 0x0);
}

/*******************************************************************************
 * 
 * NOP
 *
 ******************************************************************************/

static nil FN (28) (core * c)
{
  
}

/*******************************************************************************
 * 
 * DAD H
 *
 ******************************************************************************/

static nil FN (29) (core * c)
{
  c->HL.R16 += c->HL.R16;
}

/*******************************************************************************
 * 
 * LHLD
 *
 ******************************************************************************/

static nil FN (2A) (core * c)
{
  c->WZ.R08.L            = f_memory [++ c->PC.R16];
  c->WZ.R08.H            = f_memory [++ c->PC.R16];
  f_memory [c->WZ.R16    ] = c->HL.R08.L;
  f_memory [c->WZ.R16 + 1] = c->HL.R08.H;
}

/*******************************************************************************
 * 
 * DCX H
 *
 ******************************************************************************/

static nil FN (2B) (core * c)
{
  -- c->HL.R16;
}

/*******************************************************************************
 * 
 * INR l
 *
 ******************************************************************************/

static nil FN (2C) (core * c)
{
  ++ c->HL.R08.L;
}

/*******************************************************************************
 * 
 * DCR l
 *
 ******************************************************************************/

static nil FN (2D) (core * c)
{
  -- c->HL.R08.L;
}

/*******************************************************************************
 * 
 * MVI l, byte
 *
 ******************************************************************************/

static nil FN (2E) (core * c)
{
  c->HL.R08.L = f_memory [++ c->PC.R16];
}

/*******************************************************************************
 * 
 * CMA
 *
 ******************************************************************************/

static nil FN (2F) (core * c)
{
  f_arithmetics [0xD] (c, 0);
}

/*******************************************************************************
 * 
 * NOP
 *
 ******************************************************************************/

static nil FN (30) (core * c)
{
  
}

/*******************************************************************************
 * 
 * LXI SP, word
 *
 ******************************************************************************/

static nil FN (31) (core * c)
{
  c->SP.R08.L = f_memory [++ c->PC.R16];
  c->SP.R08.H = f_memory [++ c->PC.R16];
}

/*******************************************************************************
 * 
 * STA
 *
 ******************************************************************************/

static nil FN (32) (core * c)
{
  c->WZ.R08.L        = f_memory [++ c->PC.R16];
  c->WZ.R08.H        = f_memory [++ c->PC.R16];

  f_memory [c->WZ.R16] = c->AF.R08.L;
}

/*******************************************************************************
 * 
 * INX SP
 *
 ******************************************************************************/

static nil FN (33) (core * c)
{
  ++ c->SP.R16;
}

/*******************************************************************************
 * 
 * INR m
 *
 ******************************************************************************/

static nil FN (34) (core * c)
{
  ++ f_memory [c->HL.R16];
}

/*******************************************************************************
 * 
 * DCR m
 *
 ******************************************************************************/

static nil FN (35) (core * c)
{
  -- f_memory [c->HL.R16];
}

/*******************************************************************************
 * 
 * MVI m, byte
 *
 ******************************************************************************/

static nil FN (36) (core * c)
{
  f_memory [c->HL.R16] = f_memory [++ c->PC.R16];
}

/*******************************************************************************
 * 
 * STC
 *
 ******************************************************************************/

static nil FN (37) (core * c)
{
  f_arithmetics [0xE] (c, 0);
}

/*******************************************************************************
 * 
 * NOP
 *
 ******************************************************************************/

static nil FN (38) (core * c)
{
  
}

/*******************************************************************************
 * 
 * DAD SP
 *
 ******************************************************************************/

static nil FN (39) (core * c)
{
  c->HL.R16 += c->SP.R16;
}

/*******************************************************************************
 * 
 * LDA word
 *
 ******************************************************************************/

static nil FN (3A) (core * c)
{
  c->WZ.R08.L        = f_memory [++ c->PC.R16];
  c->WZ.R08.H        = f_memory [++ c->PC.R16];

  f_memory [c->WZ.R16] = c->AF.R08.L;
}

/*******************************************************************************
 * 
 * DCX SP
 *
 ******************************************************************************/

static nil FN (3B) (core * c)
{
  -- c->SP.R16;
}

/*******************************************************************************
 * 
 * INR a
 *
 ******************************************************************************/

static nil FN (3C) (core * c)
{
  ++ c->AF.R08.L;
}

/*******************************************************************************
 * 
 * DCR a
 *
 ******************************************************************************/

static nil FN (3D) (core * c)
{
  -- c->AF.R08.L;
}

/*******************************************************************************
 * 
 * MVI a, byte
 *
 ******************************************************************************/

static nil FN (3E) (core * c)
{
  c->AF.R08.L = f_memory [++ c->PC.R16];
}

/*******************************************************************************
 * 
 * CMC
 *
 ******************************************************************************/

static nil FN (3F) (core * c)
{
  f_arithmetics [0xF] (c, 0);
}

/*******************************************************************************
 * 
 * MOV b, b
 *
 ******************************************************************************/

static nil FN (40) (core * c)
{
  c->BC.R08.L = c->BC.R08.L;
}

/*******************************************************************************
 * 
 * MOV b, c
 *
 ******************************************************************************/

static nil FN (41) (core * c)
{
  c->BC.R08.L = c->BC.R08.H;
}

/*******************************************************************************
 * 
 * MOV b, d
 *
 ******************************************************************************/

static nil FN (42) (core * c)
{
  c->BC.R08.L = c->DE.R08.L;
}

/*******************************************************************************
 * 
 * MOV b, e
 *
 ******************************************************************************/

static nil FN (43) (core * c)
{
  c->BC.R08.L = c->DE.R08.H;
}

/*******************************************************************************
 * 
 * MOV b, h
 *
 ******************************************************************************/

static nil FN (44) (core * c)
{
  c->BC.R08.L = c->HL.R08.L;
}

/*******************************************************************************
 * 
 * MOV b, l
 *
 ******************************************************************************/

static nil FN (45) (core * c)
{
  c->BC.R08.L = c->HL.R08.H;
}

/*******************************************************************************
 * 
 * MOV b, m
 *
 ******************************************************************************/

static nil FN (46) (core * c)
{
  c->BC.R08.L = f_memory [c->PC.R16 + 1];
}

/*******************************************************************************
 * 
 * MOV b, a
 *
 ******************************************************************************/

static nil FN (47) (core * c)
{
  c->BC.R08.L = c->AF.R08.L;
}

/*******************************************************************************
 * 
 * MOV c, b
 *
 ******************************************************************************/

static nil FN (48) (core * c)
{
  c->BC.R08.H = c->BC.R08.L;
}

/*******************************************************************************
 * 
 * MOV c, c
 *
 ******************************************************************************/

static nil FN (49) (core * c)
{
  c->BC.R08.H = c->BC.R08.H;
}

/*******************************************************************************
 * 
 * MOV c, d
 *
 ******************************************************************************/

static nil FN (4A) (core * c)
{
  c->BC.R08.H = c->DE.R08.L;
}

/*******************************************************************************
 * 
 * MOV c, e
 *
 ******************************************************************************/

static nil FN (4B) (core * c)
{
  c->BC.R08.H = c->DE.R08.H;
}

/*******************************************************************************
 * 
 * MOV c, h
 *
 ******************************************************************************/

static nil FN (4C) (core * c)
{
  c->BC.R08.H = c->HL.R08.L;
}

/*******************************************************************************
 * 
 * MOV c, l
 *
 ******************************************************************************/

static nil FN (4D) (core * c)
{
  c->BC.R08.H = c->HL.R08.H;
}

/*******************************************************************************
 * 
 * MOV c, m
 *
 ******************************************************************************/

static nil FN (4E) (core * c)
{
  c->BC.R08.H = f_memory [c->PC.R16 + 1];

}

/*******************************************************************************
 * 
 * MOV c, a
 *
 ******************************************************************************/

static nil FN (4F) (core * c)
{
  c->BC.R08.H = c->AF.R08.L;
}

/*******************************************************************************
 * 
 * MOV d, b
 *
 ******************************************************************************/

static nil FN (50) (core * c)
{
  c->DE.R08.L = c->BC.R08.L;
}

/*******************************************************************************
 * 
 * MOV d, c
 *
 ******************************************************************************/

static nil FN (51) (core * c)
{
  c->DE.R08.L = c->BC.R08.H;
}

/*******************************************************************************
 * 
 * MOV d, d
 *
 ******************************************************************************/

static nil FN (52) (core * c)
{
  c->DE.R08.L = c->DE.R08.L;
}

/*******************************************************************************
 * 
 * MOV d, e
 *
 ******************************************************************************/

static nil FN (53) (core * c)
{
  c->DE.R08.L = c->DE.R08.H;
}

/*******************************************************************************
 * 
 * MOV d, h
 *
 ******************************************************************************/

static nil FN (54) (core * c)
{
  c->DE.R08.L = c->HL.R08.L;
}

/*******************************************************************************
 * 
 * MOV d, l
 *
 ******************************************************************************/

static nil FN (55) (core * c)
{
  c->DE.R08.L = c->HL.R08.H;
}

/*******************************************************************************
 * 
 * MOV d, m
 *
 ******************************************************************************/

static nil FN (56) (core * c)
{
  c->DE.R08.L = f_memory [c->PC.R16 + 1];
}

/*******************************************************************************
 * 
 * MOV d, a
 *
 ******************************************************************************/

static nil FN (57) (core * c)
{
  c->DE.R08.L = c->AF.R08.L;
}

/*******************************************************************************
 * 
 * MOV e, b
 *
 ******************************************************************************/

static nil FN (58) (core * c)
{
  c->DE.R08.H = c->BC.R08.L;
}

/*******************************************************************************
 * 
 * MOV e, c
 *
 ******************************************************************************/

static nil FN (59) (core * c)
{
  c->DE.R08.H = c->BC.R08.H;
}

/*******************************************************************************
 * 
 * MOV e, d
 *
 ******************************************************************************/

static nil FN (5A) (core * c)
{
  c->DE.R08.H = c->DE.R08.L;
}

/*******************************************************************************
 * 
 * MOV e, e
 *
 ******************************************************************************/

static nil FN (5B) (core * c)
{
  c->DE.R08.H = c->DE.R08.H;
}

/*******************************************************************************
 * 
 * MOV e, h
 *
 ******************************************************************************/

static nil FN (5C) (core * c)
{
  c->DE.R08.H = c->HL.R08.L;
}

/*******************************************************************************
 * 
 * MOV e, l
 *
 ******************************************************************************/

static nil FN (5D) (core * c)
{
  c->DE.R08.H = c->HL.R08.H;
}

/*******************************************************************************
 * 
 * MOV e, m
 *
 ******************************************************************************/

static nil FN (5E) (core * c)
{
  c->DE.R08.L = f_memory [c->PC.R16 + 1];
}

/*******************************************************************************
 * 
 * MOV e, a
 *
 ******************************************************************************/

static nil FN (5F) (core * c)
{
  c->DE.R08.H = c->AF.R08.L;
}

/*******************************************************************************
 * 
 * MOV h, b
 *
 ******************************************************************************/

static nil FN (60) (core * c)
{
  c->HL.R08.L = c->BC.R08.L;
}

/*******************************************************************************
 * 
 * MOV h, c
 *
 ******************************************************************************/

static nil FN (61) (core * c)
{
  c->HL.R08.L = c->BC.R08.H;
}

/*******************************************************************************
 * 
 * MOV h, d
 *
 ******************************************************************************/

static nil FN (62) (core * c)
{
  c->HL.R08.L = c->DE.R08.L;
}

/*******************************************************************************
 * 
 * MOV h, e
 *
 ******************************************************************************/

static nil FN (63) (core * c)
{
  c->HL.R08.L = c->DE.R08.H;
}

/*******************************************************************************
 * 
 * MOV h, h
 *
 ******************************************************************************/

static nil FN (64) (core * c)
{
  c->HL.R08.L = c->HL.R08.L;
}

/*******************************************************************************
 * 
 * MOV h, l
 *
 ******************************************************************************/

static nil FN (65) (core * c)
{
  c->HL.R08.L = c->HL.R08.H;
}

/*******************************************************************************
 * 
 * MOV h, m
 *
 ******************************************************************************/

static nil FN (66) (core * c)
{
  c->HL.R08.L= f_memory [c->PC.R16 + 1];
}

/*******************************************************************************
 * 
 * MOV h, a
 *
 ******************************************************************************/

static nil FN (67) (core * c)
{
  c->HL.R08.L = c->AF.R08.L;
}

/*******************************************************************************
 * 
 * MOV l, b
 *
 ******************************************************************************/

static nil FN (68) (core * c)
{
  c->HL.R08.H = c->BC.R08.L;
}

/*******************************************************************************
 * 
 * MOV l, c
 *
 ******************************************************************************/

static nil FN (69) (core * c)
{
  c->HL.R08.H = c->BC.R08.H;
}

/*******************************************************************************
 * 
 * MOV l, d
 *
 ******************************************************************************/

static nil FN (6A) (core * c)
{
  c->HL.R08.H = c->DE.R08.L;
}

/*******************************************************************************
 * 
 * MOV l, e
 *
 ******************************************************************************/

static nil FN (6B) (core * c)
{
  c->HL.R08.H = c->DE.R08.H;
}

/*******************************************************************************
 * 
 * MOV l, h
 *
 ******************************************************************************/

static nil FN (6C) (core * c)
{
  c->HL.R08.H = c->HL.R08.L;
}

/*******************************************************************************
 * 
 * MOV l, l
 *
 ******************************************************************************/

static nil FN (6D) (core * c)
{
  c->HL.R08.H = c->HL.R08.H;
}

/*******************************************************************************
 * 
 * MOV l, m
 *
 ******************************************************************************/

static nil FN (6E) (core * c)
{
  c->HL.R08.H = f_memory [c->PC.R16 + 1];
}

/*******************************************************************************
 * 
 * MOV l, a
 *
 ******************************************************************************/

static nil FN (6F) (core * c)
{
  c->HL.R08.H = c->AF.R08.L;
}

/*******************************************************************************
 * 
 * MOV m, b
 *
 ******************************************************************************/

static nil FN (70) (core * c)
{
  f_memory [c->HL.R16] = c->BC.R08.L;
}

/*******************************************************************************
 * 
 * MOV m, c
 *
 ******************************************************************************/

static nil FN (71) (core * c)
{
  f_memory [c->HL.R16] = c->BC.R08.H;
}

/*******************************************************************************
 * 
 * MOV m, d
 *
 ******************************************************************************/

static nil FN (72) (core * c)
{
  f_memory [c->HL.R16] = c->DE.R08.L;
}

/*******************************************************************************
 * 
 * MOV m, e
 *
 ******************************************************************************/

static nil FN (73) (core * c)
{
  f_memory [c->HL.R16] = c->DE.R08.H;
}

/*******************************************************************************
 * 
 * MOV m, h
 *
 ******************************************************************************/

static nil FN (74) (core * c)
{
  f_memory [c->HL.R16] = c->HL.R08.L;
}

/*******************************************************************************
 * 
 * MOV m, l
 *
 ******************************************************************************/

static nil FN (75) (core * c)
{
  f_memory [c->HL.R16] = c->HL.R08.H;
}

/*******************************************************************************
 * 
 * HALT
 *
 ******************************************************************************/

static nil FN (76) (core * c)
{
  -- c->PC.R16;
}

/*******************************************************************************
 * 
 * MOV m, a
 *
 ******************************************************************************/

static nil FN (77) (core * c)
{
  f_memory [c->HL.R16] = c->AF.R08.L;
}

/*******************************************************************************
 * 
 * MOV a, b
 *
 ******************************************************************************/

static nil FN (78) (core * c)
{
  c->AF.R08.L = c->BC.R08.L;
}

/*******************************************************************************
 * 
 * MOV a, c
 *
 ******************************************************************************/

static nil FN (79) (core * c)
{
  c->AF.R08.L = c->BC.R08.H;
}

/*******************************************************************************
 * 
 * MOV a, d
 *
 ******************************************************************************/

static nil FN (7A) (core * c)
{
  c->AF.R08.L = c->DE.R08.L;
}

/*******************************************************************************
 * 
 * MOV a, e
 *
 ******************************************************************************/

static nil FN (7B) (core * c)
{
  c->AF.R08.L = c->DE.R08.H;
}

/*******************************************************************************
 * 
 * MOV a, h
 *
 ******************************************************************************/

static nil FN (7C) (core * c)
{
  c->AF.R08.L = c->HL.R08.L;
}

/*******************************************************************************
 * 
 * MOV a, l
 *
 ******************************************************************************/

static nil FN (7D) (core * c)
{
  c->AF.R08.L = c->HL.R08.H;
}

/*******************************************************************************
 * 
 * MOV a, m
 *
 ******************************************************************************/

static nil FN (7E) (core * c)
{
  c->AF.R08.L = f_memory [c->HL.R16];
}

/*******************************************************************************
 * 
 * MOV a, a
 *
 ******************************************************************************/

static nil FN (7F) (core * c)
{
  c->AF.R08.L = c->AF.R08.L;
}

/*******************************************************************************
 * 
 * ADD b
 *
 ******************************************************************************/

static nil FN (80) (core * c)
{
  f_arithmetics [0x0] (c, c->BC.R08.L);
}

/*******************************************************************************
 * 
 * ADD c
 *
 ******************************************************************************/

static nil FN (81) (core * c)
{
  f_arithmetics [0x0] (c, c->BC.R08.H);
}

/*******************************************************************************
 * 
 * ADD d
 *
 ******************************************************************************/

static nil FN (82) (core * c)
{
  f_arithmetics [0x0](c, c->DE.R08.L);
}

/*******************************************************************************
 * 
 * ADD e
 *
 ******************************************************************************/

static nil FN (83) (core * c)
{
  f_arithmetics [0x0](c, c->DE.R08.H);
}

/*******************************************************************************
 * 
 * ADD h
 *
 ******************************************************************************/

static nil FN (84) (core * c)
{
  f_arithmetics [0x0] (c, c->HL.R08.L);
}

/*******************************************************************************
 * 
 * ADD l
 *
 ******************************************************************************/

static nil FN (85) (core * c)
{
  f_arithmetics [0x0] (c, c->HL.R08.H);
}

/*******************************************************************************
 * 
 * ADD m
 *
 ******************************************************************************/

static nil FN (86) (core * c)
{
  f_arithmetics [0x0] (c, f_memory [c->HL.R16]);
}

/*******************************************************************************
 * 
 * ADD a
 *
 ******************************************************************************/

static nil FN (87) (core * c)
{
  f_arithmetics [0x0] (c, c->AF.R08.L);
}

/*******************************************************************************
 * 
 * ADC b
 *
 ******************************************************************************/

static nil FN (88) (core * c)
{
  f_arithmetics [0x1] (c, c->BC.R08.L);
}

/*******************************************************************************
 * 
 * ADC c
 *
 ******************************************************************************/

static nil FN (89) (core * c)
{
  f_arithmetics [0x1] (c, c->BC.R08.H);
}

/*******************************************************************************
 * 
 * ADC d
 *
 ******************************************************************************/

static nil FN (8A) (core * c)
{
  f_arithmetics [0x1] (c, c->DE.R08.L);
}

/*******************************************************************************
 * 
 * ADD e
 *
 ******************************************************************************/

static nil FN (8B) (core * c)
{
  f_arithmetics [0x1] (c, c->DE.R08.H);
}

/*******************************************************************************
 * 
 * ADD h
 *
 ******************************************************************************/

static nil FN (8C) (core * c)
{
  f_arithmetics [0x1] (c, c->HL.R08.L);
}

/*******************************************************************************
 * 
 * ADD l
 *
 ******************************************************************************/

static nil FN (8D) (core * c)
{
  f_arithmetics [0x1] (c, c->HL.R08.H);
}

/*******************************************************************************
 * 
 * ADC m
 *
 ******************************************************************************/

static nil FN (8E) (core * c)
{
  f_arithmetics [0x1] (c, f_memory [c->HL.R16]);
}

/*******************************************************************************
 * 
 * ADC a
 *
 ******************************************************************************/

static nil FN (8F) (core * c)
{
  f_arithmetics [0x1](c, c->AF.R08.L);
}

/*******************************************************************************
 * 
 * SUB b
 * 
 ******************************************************************************/

static nil FN (90) (core * c)
{
  f_arithmetics [0x2] (c, c->BC.R08.L);
}

/*******************************************************************************
 * 
 * SUB c
 * 
 ******************************************************************************/

static nil FN (91) (core * c)
{
  f_arithmetics [0x2] (c, c->BC.R08.H);
}

/*******************************************************************************
 * 
 * SUB d
 * 
 ******************************************************************************/

static nil FN (92) (core * c)
{
  f_arithmetics [0x2](c, c->DE.R08.L);
}

/*******************************************************************************
 * 
 * SUB e
 * 
 ******************************************************************************/

static nil FN (93) (core * c)
{
  f_arithmetics [0x2] (c, c->DE.R08.H);
}

/*******************************************************************************
 * 
 * SUB h
 * 
 ******************************************************************************/

static nil FN (94) (core * c)
{
  f_arithmetics [0x2] (c, c->HL.R08.L);
}

/*******************************************************************************
 * 
 * SUB l
 * 
 ******************************************************************************/

static nil FN (95) (core * c)
{
  f_arithmetics [0x2](c, c->HL.R08.H);
}

/*******************************************************************************
 * 
 * SUB m
 * 
 ******************************************************************************/

static nil FN (96) (core * c)
{
  f_arithmetics [0x2] (c, f_memory [c->HL.R16]);
}

/*******************************************************************************
 * 
 * SUB a
 * 
 ******************************************************************************/

static nil FN (97) (core * c)
{
  f_arithmetics [0x2] (c, c->BC.R08.L);
}

/*******************************************************************************
 * 
 * SBB b
 * 
 ******************************************************************************/

static nil FN (98) (core * c)
{
  f_arithmetics [0x3](c, c->BC.R08.L);
}

/*******************************************************************************
 * 
 * SBB c
 * 
 ******************************************************************************/

static nil FN (99) (core * c)
{
  f_arithmetics [0x3](c, c->BC.R08.H);
}

/*******************************************************************************
 * 
 * SBB d
 * 
 ******************************************************************************/

static nil FN (9A) (core * c)
{
  f_arithmetics [0x3] (c, c->DE.R08.L);
}

/*******************************************************************************
 * 
 * SBB e
 * 
 ******************************************************************************/

static nil FN (9B) (core * c)
{
  f_arithmetics [0x3] (c, c->DE.R08.H);
}

/*******************************************************************************
 * 
 * SBB h
 * 
 ******************************************************************************/

static nil FN (9C) (core * c)
{
  f_arithmetics [0x3](c, c->HL.R08.L);
}

/*******************************************************************************
 * 
 * SBB l
 * 
 ******************************************************************************/

static nil FN (9D) (core * c)
{
  f_arithmetics [0x3] (c, c->HL.R08.H);
}

/*******************************************************************************
 * 
 * SBB m
 * 
 ******************************************************************************/

static nil FN (9E) (core * c)
{
  f_arithmetics [0x3] (c, f_memory [c->HL.R16]);
}

/*******************************************************************************
 * 
 * SBB a
 * 
 ******************************************************************************/

static nil FN (9F) (core * c)
{
  f_arithmetics [0x3](c, c->WZ.R08.L);
}

/*******************************************************************************
 * 
 * ANA b
 * 
 ******************************************************************************/

static nil FN (A0) (core * c)
{
  f_arithmetics [0x4](c, c->BC.R08.L);
}

/*******************************************************************************
 * 
 * ANA c
 * 
 ******************************************************************************/

static nil FN (A1) (core * c)
{
  f_arithmetics [0x4](c, c->BC.R08.H);
}

/*******************************************************************************
 * 
 * ANA d
 * 
 ******************************************************************************/

static nil FN (A2) (core * c)
{
  f_arithmetics [0x4](c, c->DE.R08.L);
}

/*******************************************************************************
 * 
 * ANA e
 * 
 ******************************************************************************/

static nil FN (A3) (core * c)
{
  f_arithmetics [0x4] (c, c->DE.R08.H);
}

/*******************************************************************************
 * 
 * ANA h
 * 
 ******************************************************************************/

static nil FN (A4) (core * c)
{
  f_arithmetics [0x4](c, c->HL.R08.L);
}

/*******************************************************************************
 * 
 * ANA l
 * 
 ******************************************************************************/

static nil FN (A5) (core * c)
{
  f_arithmetics [0x4] (c, c->HL.R08.H);
}

/*******************************************************************************
 * 
 * ANA m
 * 
 ******************************************************************************/

static nil FN (A6) (core * c)
{
  f_arithmetics [0x4] (c, f_memory [c->HL.R16]);
}

/*******************************************************************************
 * 
 * ANA a
 * 
 ******************************************************************************/

static nil FN (A7) (core * c)
{
  f_arithmetics [0x4] (c, c->AF.R08.L);
}

/*******************************************************************************
 * 
 * XRA b
 * 
 ******************************************************************************/

static nil FN (A8) (core * c)
{
  f_arithmetics [0x5] (c, c->BC.R08.L);
}

/*******************************************************************************
 * 
 * XRA c
 * 
 ******************************************************************************/

static nil FN (A9) (core * c)
{
  f_arithmetics [0x5] (c, c->BC.R08.H);
}

/*******************************************************************************
 * 
 * XRA d
 * 
 ******************************************************************************/

static nil FN (AA) (core * c)
{
  f_arithmetics [0x5] (c, c->DE.R08.L);
}

/*******************************************************************************
 * 
 * XRA e
 * 
 ******************************************************************************/

static nil FN (AB) (core * c)
{
  f_arithmetics [0x5](c, c->DE.R08.H);
}

/*******************************************************************************
 * 
 * XRA h
 * 
 ******************************************************************************/

static nil FN (AC) (core * c)
{
  f_arithmetics [0x5] (c, c->HL.R08.L);
}

/*******************************************************************************
 * 
 * XRA l
 * 
 ******************************************************************************/

static nil FN (AD) (core * c)
{
  f_arithmetics [0x5] (c, c->HL.R08.H);
}

/*******************************************************************************
 * 
 * XRA m
 * 
 ******************************************************************************/

static nil FN (AE) (core * c)
{
  f_arithmetics [0x5] (c, f_memory [c->HL.R16]);
}

/*******************************************************************************
 * 
 * XRA a
 * 
 ******************************************************************************/

static nil FN (AF) (core * c)
{
  f_arithmetics [0x5] (c, c->AF.R08.L);
}

/*******************************************************************************
 * 
 * ORA b
 * 
 ******************************************************************************/

static nil FN (B0) (core * c)
{
  f_arithmetics [0x6] (c, c->BC.R08.L);
}

/*******************************************************************************
 * 
 * ORA c
 * 
 ******************************************************************************/

static nil FN (B1) (core * c)
{
  f_arithmetics [0x6] (c, c->BC.R08.H);
}

/*******************************************************************************
 * 
 * ORA d
 * 
 ******************************************************************************/

static nil FN (B2) (core * c)
{
  f_arithmetics [0x6] (c, c->DE.R08.L);
}

/*******************************************************************************
 * 
 * ORA e
 * 
 ******************************************************************************/

static nil FN (B3) (core * c)
{
  f_arithmetics [0x6] (c, c->DE.R08.H);
}

/*******************************************************************************
 * 
 * ORA h
 * 
 ******************************************************************************/

static nil FN (B4) (core * c)
{
  f_arithmetics [0x6] (c, c->HL.R08.L);
}

/*******************************************************************************
 * 
 * ORA l
 * 
 ******************************************************************************/

static nil FN (B5) (core * c)
{
  f_arithmetics [0x6] (c, c->HL.R08.H);
}

/*******************************************************************************
 * 
 * ORA m
 * 
 ******************************************************************************/

static nil FN (B6) (core * c)
{
  f_arithmetics [0x6] (c, f_memory [c->HL.R16]);
}

/*******************************************************************************
 * 
 * ORA a
 * 
 ******************************************************************************/

static nil FN (B7) (core * c)
{
  f_arithmetics [0x6](c, c->AF.R08.L);
}

/*******************************************************************************
 * 
 * CMP b
 * 
 ******************************************************************************/

static nil FN (B8) (core * c)
{
  f_arithmetics [0x7](c, c->BC.R08.L);
}

/*******************************************************************************
 * 
 * CMP c
 * 
 ******************************************************************************/

static nil FN (B9) (core * c)
{
  f_arithmetics [0x7] (c, c->BC.R08.H);
}

/*******************************************************************************
 * 
 * CMP d
 * 
 ******************************************************************************/

static nil FN (BA) (core * c)
{
  f_arithmetics [0x7] (c, c->DE.R08.L);
}

/*******************************************************************************
 * 
 * CMP e
 * 
 ******************************************************************************/

static nil FN (BB) (core * c)
{
  f_arithmetics [0x7] (c, c->DE.R08.H);
}

/*******************************************************************************
 * 
 * CMP h
 * 
 ******************************************************************************/

static nil FN (BC) (core * c)
{
  f_arithmetics [0x7] (c, c->HL.R08.L);
}

/*******************************************************************************
 * 
 * CMP l
 * 
 ******************************************************************************/

static nil FN (BD) (core * c)
{
  f_arithmetics [0x7](c, c->HL.R08.H);
}

/*******************************************************************************
 * 
 * CMP m
 * 
 ******************************************************************************/

static nil FN (BE) (core * c)
{
  f_arithmetics [0x7] (c, f_memory [c->HL.R16]);
}

/*******************************************************************************
 * 
 * CMP a
 * 
 ******************************************************************************/

static nil FN (BF) (core * c)
{
  f_arithmetics [0x7] (c, c->AF.R08.L);
}

/*******************************************************************************
 * 
 * RNZ
 * 
 ******************************************************************************/

static nil FN (C0) (core * c)
{
  if (! (c->AF.R08.H & FLAG_ZERO))
  {
    c->branch = BRANCH_P; f_instruction [0xC9] (c);
  }
}

/*******************************************************************************
 * 
 * POP B
 * 
 ******************************************************************************/

static nil FN (C1) (core * c)
{
  c->BC.R08.L = f_memory [c->SP.R16 ++];
  c->BC.R08.H = f_memory [c->SP.R16 ++];
}

/*******************************************************************************
 * 
 * JNZ
 * 
 ******************************************************************************/

static nil FN (C2) (core * c)
{
  if (! (c->AF.R08.H & FLAG_ZERO))
  {
    c->branch = BRANCH_P; f_instruction [0xC3] (c);
  } 
  else 
  {
    c->PC.R16 += 2;
  }
}

/*******************************************************************************
 * 
 * JMP
 * 
 ******************************************************************************/

static nil FN (C3) (core * c)
{
  c->WZ.R16   = c->PC.R16;
  c->PC.R08.L = f_memory [c->WZ.R16 + 1];
  c->PC.R08.H = f_memory [c->WZ.R16 + 2];
  c->PC.R16   = c->PC.R16 - 1;
}

/*******************************************************************************
 * 
 * CNZ
 * 
 ******************************************************************************/

static nil FN (C4) (core * c)
{
  if (! (c->AF.R08.H & FLAG_ZERO))
  {
    c->branch = BRANCH_P; f_instruction [0xCD] (c);
  } 
  else 
  {
    c->PC.R16 += 2;
  }
}

/*******************************************************************************
 * 
 * PUSH B
 * 
 ******************************************************************************/

static nil FN (C5) (core * c)
{
  f_memory [-- c->SP.R16] = c->BC.R08.H;
  f_memory [-- c->SP.R16] = c->BC.R08.L;
}

/*******************************************************************************
 * 
 * ADI byte
 * 
 ******************************************************************************/

static nil FN (C6) (core * c)
{
  f_arithmetics [0x0] (c, f_memory [++ c->PC.R16]);
}

/*******************************************************************************
 * 
 * RST 0
 * 
 ******************************************************************************/

static void FN (C7) (core * c)
{
  f_memory [-- c->SP.R16] = c->PC.R08.H;
  f_memory [-- c->SP.R16] = c->PC.R08.L;

  c->PC.R16 = 0xFFFF;
}

/*******************************************************************************
 * 
 * RZ
 * 
 ******************************************************************************/

static nil FN (C8) (core * c)
{
  if (c->AF.R08.H & FLAG_ZERO)
  {
    c->branch = BRANCH_P; ++ f_cycles, f_instruction [0xC9] (c);
  }
}

/*******************************************************************************
 * 
 * RET
 * 
 ******************************************************************************/

static nil FN (C9) (core * c)
{
  c->PC.R08.H = f_memory [c->SP.R16 ++];
  c->PC.R08.L = f_memory [c->SP.R16 ++];
}

/*******************************************************************************
 * 
 * JZ
 * 
 ******************************************************************************/

static nil FN (CA) (core * c)
{
  if (c->AF.R08.H & FLAG_ZERO)
  {
    f_instruction [0xC3] (c);
  } 
  else 
  {
    c->PC.R16 += 2;
  }
}

/*******************************************************************************
 * 
 * NOP
 * 
 ******************************************************************************/

static nil FN (CB) (core * c)
{

}

/*******************************************************************************
 * 
 * CZ
 * 
 ******************************************************************************/

static nil FN (CC) (core * c)
{
  if (c->AF.R08.H & FLAG_ZERO)
  {
    c->branch = BRANCH_P; f_instruction [0xCD] (c);
  } 
  else 
  {
    c->PC.R16 += 2;
  }
}

/*******************************************************************************
 * 
 * CALL word
 * 
 ******************************************************************************/

#define CALL_BASE_ROUTINE                             \
  f_memory [-- c->SP.R16] = c->PC.R08.H;              \
  f_memory [-- c->SP.R16] = c->PC.R08.L;              \
  c->WZ.R16               = c->PC.R16;                \
  c->PC.R08.L             = f_memory [c->WZ.R16 + 1]; \
  c->PC.R08.H             = f_memory [c->WZ.R16 + 2]; \
  c->PC.R16               = c->PC.R16 - 1

static nil FN (CD) (core * c)
{
  CALL_BASE_ROUTINE;
}

/*******************************************************************************
 * 
 * ACI byte
 * 
 ******************************************************************************/

static nil FN (CE) (core * c)
{
  f_arithmetics [0x1] (c, f_memory [++ c->PC.R16]);
}

/*******************************************************************************
 * 
 * RST 1
 * 
 ******************************************************************************/

static nil FN (CF) (core * c)
{
  f_memory [-- c->SP.R16] = c->PC.R08.H;
  f_memory [-- c->SP.R16] = c->PC.R08.L;

  c->PC.R16 = 0x08 - 1;
}

/*******************************************************************************
 * 
 * RNC
 * 
 ******************************************************************************/

static nil FN (D0) (core * c)
{
  if (! (c->AF.R08.H & FLAG_CARRY))
  {
    c->branch = BRANCH_P; ++ f_cycles, f_instruction [0xC9] (c);
  }
}

/*******************************************************************************
 * 
 * POP D
 * 
 ******************************************************************************/

static nil FN (D1) (core * c)
{
  c->DE.R08.L = f_memory [c->SP.R16 ++];
  c->DE.R08.H = f_memory [c->SP.R16 ++];
}

/*******************************************************************************
 * 
 * JNC
 * 
 ******************************************************************************/

static nil FN (D2) (core * c)
{
  if (! (c->AF.R08.H & FLAG_CARRY))
  {
    c->branch = BRANCH_P; f_instruction [0xC3] (c);
  } 
  else 
  {
    c->PC.R16 += 2;
  }
}

/*******************************************************************************
 * 
 * OUT
 * 
 ******************************************************************************/

static nil FN (D3) (core * c)
{  
  f_port_o [f_memory [++c->PC.R16]] =  c->AF.R08.L;
}

/*******************************************************************************
 * 
 * CNC
 * 
 ******************************************************************************/

static nil FN (D4) (core * c)
{
  if (! (c->AF.R08.H & FLAG_CARRY))
  {
    c->branch = BRANCH_P; f_instruction [0xCD] (c);
  } 
  else 
  {
    c->PC.R16 += 2;
  }
}

/*******************************************************************************
 * 
 * PUSH D
 * 
 ******************************************************************************/

static nil FN (D5) (core * c)
{
  f_memory [-- c->SP.R16] = c->DE.R08.H;
  f_memory [-- c->SP.R16] = c->DE.R08.L;
}

/*******************************************************************************
 * 
 * SUI
 * 
 ******************************************************************************/

static nil FN (D6) (core * c)
{
  f_arithmetics [0x2] (c, f_memory [++ c->PC.R16]);
}

/*******************************************************************************
 * 
 * RST 2
 * 
 ******************************************************************************/

static nil FN (D7) (core * c)
{
  f_memory [-- c->SP.R16] = c->PC.R08.H;
  f_memory [-- c->SP.R16] = c->PC.R08.L;

  c->PC.R16 = 0x10 - 1;
}

/*******************************************************************************
 * 
 * RC
 * 
 ******************************************************************************/

static nil FN (D8) (core * c)
{
  if (c->AF.R08.H & FLAG_CARRY)
    {
      c->branch = BRANCH_P; ++ f_cycles, f_instruction [0xC9] (c);
    }
}

/*******************************************************************************
 * 
 * NOP
 *
 ******************************************************************************/

static nil FN (D9) (core * c)
{

}

/*******************************************************************************
 * 
 * JC
 * 
 ******************************************************************************/

static nil FN (DA) (core * c)
{
  if (c->AF.R08.H & FLAG_CARRY)
  {
    c->branch = BRANCH_P; f_instruction [0xCD] (c);
  } 
  else 
  {
    c->PC.R16 += 2;
  }
}

/*******************************************************************************
 * 
 * IN
 * 
 ******************************************************************************/

static nil FN (DB) (core * c)
{
  c->AF.R08.L = f_port_i [f_memory [c->PC.R16 ++]];
}

/*******************************************************************************
 * 
 * CC
 * 
 ******************************************************************************/

static nil FN (DC) (core * c)
{
  if (c->AF.R08.H & FLAG_CARRY)
  {
    c->branch = BRANCH_P; f_instruction [0xCD] (c);
  } 
  else 
  {
    c->PC.R16 += 2;
  }
}

/*******************************************************************************
 * 
 * NOP
 * 
 ******************************************************************************/

static nil FN (DD) (core * c)
{

}

/*******************************************************************************
 * 
 * SBI
 * 
 ******************************************************************************/

static nil FN (DE) (core * c)
{
  f_arithmetics [0x3] (c, f_memory [++ c->PC.R16]);
}

/*******************************************************************************
 * 
 * RST 3
 * 
 ******************************************************************************/

static nil FN (DF) (core * c)
{
  f_memory [-- c->SP.R16] = c->PC.R08.H;
  f_memory [-- c->SP.R16] = c->PC.R08.L;

  c->PC.R16 = 0x18 - 1;
}

/*******************************************************************************
 * 
 * RPO
 * 
 ******************************************************************************/

static nil FN (E0) (core * c)
{
  if (! (c->AF.R08.H & FLAG_PARITY))
    {
      c->branch = BRANCH_P; f_instruction [0xC9] (c);
    }
}

/*******************************************************************************
 * 
 * POP H
 * 
 ******************************************************************************/

static nil FN (E1) (core * c)
{
  c->HL.R08.L = f_memory [c->SP.R16 ++];
  c->HL.R08.H = f_memory [c->SP.R16 ++];
}

/*******************************************************************************
 * 
 * JPO word
 * 
 ******************************************************************************/

static nil FN (E2) (core * c)
{
  if(! (c->AF.R08.H & FLAG_PARITY))
  {
    c->branch = BRANCH_P; f_instruction [0xC3] (c);
  } 
  else 
  {
    c->PC.R16 += 2;
  }
}

/*******************************************************************************
 * 
 * XTHL
 * 
 ******************************************************************************/

static nil FN (E3) (core * c)
{
  c->WZ.R08.L = f_memory [c->SP.R16];
  c->WZ.R08.H = f_memory [c->SP.R16 + 1];

  f_memory [c->SP.R16] = c->HL.R08.L;
  f_memory [c->SP.R16 + 1] = c->HL.R08.H;

  c->HL.R16 = c->WZ.R16;
}

/*******************************************************************************
 * 
 * CPO
 * 
 ******************************************************************************/

static nil FN (E4) (core * c)
{
  if (! (c->AF.R08.H & FLAG_PARITY))
    {
      c->branch = BRANCH_P; f_instruction [0xCD] (c);
    }
}

/*******************************************************************************
 * 
 * PUSH H
 * 
 ******************************************************************************/

static nil FN (E5) (core * c)
{
  f_memory [-- c->SP.R16] = c->HL.R08.H;
  f_memory [-- c->SP.R16] = c->HL.R08.L;
}

/*******************************************************************************
 * 
 * ANI byte
 * 
 ******************************************************************************/

static nil FN (E6) (core * c)
{
  f_arithmetics [0x4] (c, f_memory [++ c->PC.R16]);
}

/*******************************************************************************
 * 
 * RST 4
 * 
 ******************************************************************************/

static nil FN (E7) (core * c)
{
  f_memory [-- c->SP.R16] = c->PC.R08.H;
  f_memory [-- c->SP.R16] = c->PC.R08.L;

  c->PC.R16 = 0x20 - 1;
}

/*******************************************************************************
 * 
 * RPE
 * 
 ******************************************************************************/

static nil FN (E8) (core * c)
{
  if (c->AF.R08.H & FLAG_PARITY)
  {
    c->branch = BRANCH_P; ++ f_cycles, f_instruction [0xC9] (c);
  }
}

/*******************************************************************************
 * 
 * PCHL
 * 
 ******************************************************************************/

static nil FN (E9) (core * c)
{
  c->PC.R16 = c->HL.R16;
}

/*******************************************************************************
 * 
 * JPE
 * 
 ******************************************************************************/

static nil FN (EA) (core * c)
{
  if (c->AF.R08.H & FLAG_PARITY)
  {
    c->branch = BRANCH_P; f_instruction [0xC3] (c);
  } 
  else 
  {
    c->PC.R16 += 2;
  }
}

/*******************************************************************************
 * 
 * XCHG
 * 
 ******************************************************************************/

static nil FN (EB) (core * c)
{
  c->WZ.R16 = c->HL.R16;
  c->HL.R16 = c->DE.R16;
  c->DE.R16 = c->WZ.R16;
}

/*******************************************************************************
 * 
 * CPE
 * 
 ******************************************************************************/

static nil FN (EC) (core * c)
{
  if (c->AF.R08.H & FLAG_PARITY)
  {
    c->branch = BRANCH_P; f_instruction [0xCD] (c);
  } 
  else 
  {
    c->PC.R16 += 2;
  }
}

/*******************************************************************************
 * 
 * NOP
 * 
 ******************************************************************************/

static nil FN (ED) (core * c)
{

}

/*******************************************************************************
 * 
 * XRI byte
 * 
 ******************************************************************************/

static nil FN (EE) (core * c)
{
  f_arithmetics [0x7] (c, f_memory [++ c->PC.R16]);
}

/*******************************************************************************
 * 
 * RST 5
 * 
 ******************************************************************************/

static nil FN (EF) (core * c)
{
  f_memory [-- c->SP.R16] = c->PC.R08.H;
  f_memory [-- c->SP.R16] = c->PC.R08.L;

  c->PC.R16 = 0x28 - 1;
}

/*******************************************************************************
 * 
 * RP
 * 
 ******************************************************************************/

static nil FN (F0) (core * c)
{
  if (! (c->AF.R08.H& FLAG_ZERO))
  {
    c->branch = BRANCH_P; ++ f_cycles, f_instruction [0xC9] (c);
  }
}

/*******************************************************************************
 * 
 * POP PSW
 * 
 ******************************************************************************/

static nil FN (F1) (core * c)
{
  c->AF.R08.L = f_memory [c->SP.R16 ++];
  c->AF.R08.H = f_memory [c->SP.R16 ++];
}

/*******************************************************************************
 * 
 * JP
 * 
 ******************************************************************************/

static nil FN (F2) (core * c)
{
  if (! (c->AF.R08.H & FLAG_ZERO))
  {
    c->branch = BRANCH_P; f_instruction [0xC3] (c);
  } 
  else 
  {
    c->PC.R16 += 2;
  }
}

/*******************************************************************************
 * 
 * DI
 * 
 ******************************************************************************/

static nil FN (F3) (core * c)
{
  c->interrupt = INTERRUPT_N;
}

/*******************************************************************************
 * 
 * CP
 * 
 ******************************************************************************/

static nil FN (F4) (core * c)
{
  if (! (c->AF.R08.H & FLAG_SIGN))
  {
    c->branch = BRANCH_P; f_instruction [0xCD] (c);
  } 
  else 
  {
    c->PC.R16 += 2;
  }
}

/*******************************************************************************
 * 
 * PUSH PSW
 * 
 ******************************************************************************/

static nil FN (F5) (core * c)
{
  f_memory [-- c->SP.R16] = c->AF.R08.H;
  f_memory [-- c->SP.R16] = c->AF.R08.L;
}

/*******************************************************************************
 * 
 * ORI byte
 * 
 ******************************************************************************/

static nil FN (F6) (core * c)
{
  f_arithmetics [0x6] (c, f_memory [++ c->PC.R16]);
}

/*******************************************************************************
 * 
 * RST 6
 * 
 ******************************************************************************/

static nil FN (F7) (core * c)
{
  f_memory [-- c->SP.R16] = c->PC.R08.H;
  f_memory [-- c->SP.R16] = c->PC.R08.L;

  c->PC.R16 = 0x30 - 1;
}

/*******************************************************************************
 * 
 * RM
 * 
 ******************************************************************************/

static nil FN (F8) (core * c)
{
  if (c->AF.R16 & FLAG_SIGN)
  {
    c->branch = BRANCH_P; f_instruction [0xC9] (c);
  }
}

/*******************************************************************************
 * 
 * SPHL
 * 
 ******************************************************************************/

static nil FN (F9) (core * c)
{
  c->SP.R16 = c->HL.R16;
}

/*******************************************************************************
 * 
 * JM
 * 
 ******************************************************************************/

static nil FN (FA) (core * c)
{
  if (c->AF.R08.H & FLAG_SIGN)
  {
    c->branch = BRANCH_P; f_instruction [0xC3] (c);
  } 
  else 
  {
    c->PC.R16 += 2;
  }
}

/*******************************************************************************
 * 
 * EI
 * 
 ******************************************************************************/

static nil FN (FB) (core * c)
{
  c->interrupt = INTERRUPT_P;
}

/*******************************************************************************
 * 
 * CM
 * 
 ******************************************************************************/

static nil FN (FC) (core * c)
{
  if (c->AF.R08.H & FLAG_SIGN)
  {
    c->branch = BRANCH_P; f_instruction [0xCD] (c);
  } 
  else 
  {
    c->PC.R16 += 2;
  }
}

/*******************************************************************************
 * 
 * NOP
 * 
 ******************************************************************************/

static nil FN (FD) (core * c)
{

}

/*******************************************************************************
 * 
 * CPI BYTE
 * 
 ******************************************************************************/

static nil FN (FE) (core * c)
{
  f_arithmetics [0x7] (c, f_memory [++ c->PC.R16]);
}

/*******************************************************************************
 * 
 * RST 7
 * 
 ******************************************************************************/

static nil FN (FF) (core * c)
{
  f_memory [-- c->SP.R16] = c->PC.R08.H;
  f_memory [-- c->SP.R16] = c->PC.R08.L; 

  c->PC.R16 = 0x38 - 1;
}

/*******************************************************************************
 * 
 * BANK
 * 
 ******************************************************************************/

static nil (* f_instruction [0x100]) (core *) =
{
  FN (00), FN (01), FN (02), FN (03), FN (04), FN (05), FN (06), FN (07),
  FN (08), FN (09), FN (0A), FN (0B), FN (0C), FN (0D), FN (0E), FN (0F),

  FN (10), FN (11), FN (12), FN (13), FN (14), FN (15), FN (16), FN (17),
  FN (18), FN (19), FN (1A), FN (1B), FN (1C), FN (1D), FN (1E), FN (1F),

  FN (20), FN (21), FN (22), FN (23), FN (24), FN (25), FN (26), FN (27),
  FN (28), FN (29), FN (2A), FN (2B), FN (2C), FN (2D), FN (2E), FN (2F),

  FN (30), FN (31), FN (32), FN (33), FN (34), FN (35), FN (36), FN (37),
  FN (38), FN (39), FN (3A), FN (3B), FN (3C), FN (3D), FN (3E), FN (3F),

  FN (40), FN (41), FN (42), FN (43), FN (44), FN (45), FN (46), FN (47),
  FN (48), FN (49), FN (4A), FN (4B), FN (4C), FN (4D), FN (4E), FN (4F),

  FN (50), FN (51), FN (52), FN (53), FN (54), FN (55), FN (56), FN (57),
  FN (58), FN (59), FN (5A), FN (5B), FN (5C), FN (5D), FN (5E), FN (5F),

  FN (60), FN (61), FN (62), FN (63), FN (64), FN (65), FN (66), FN (67),
  FN (68), FN (69), FN (6A), FN (6B), FN (6C), FN (6D), FN (6E), FN (6F),

  FN (70), FN (71), FN (72), FN (73), FN (74), FN (75), FN (76), FN (77),
  FN (78), FN (79), FN (7A), FN (7B), FN (7C), FN (7D), FN (7E), FN (7F),

  FN (80), FN (81), FN (82), FN (83), FN (84), FN (85), FN (86), FN (87),
  FN (88), FN (89), FN (8A), FN (8B), FN (8C), FN (8D), FN (8E), FN (8F),

  FN (90), FN (91), FN (92), FN (93), FN (94), FN (95), FN (96), FN (97),
  FN (98), FN (99), FN (9A), FN (9B), FN (9C), FN (9D), FN (9E), FN (9F),

  FN (A0), FN (A1), FN (A2), FN (A3), FN (A4), FN (A5), FN (A6), FN (A7),
  FN (A8), FN (A9), FN (AA), FN (AB), FN (AC), FN (AD), FN (AE), FN (AF),

  FN (B0), FN (B1), FN (B2), FN (B3), FN (B4), FN (B5), FN (B6), FN (B7),
  FN (B8), FN (B9), FN (BA), FN (BB), FN (BC), FN (BD), FN (BE), FN (BF),

  FN (C0), FN (C1), FN (C2), FN (C3), FN (C4), FN (C5), FN (C6), FN (C7),
  FN (C8), FN (C9), FN (CA), FN (CB), FN (CC), FN (CD), FN (CE), FN (CF),

  FN (D0), FN (D1), FN (D2), FN (D3), FN (D4), FN (D5), FN (D6), FN (D7),
  FN (D8), FN (D9), FN (DA), FN (DB), FN (DC), FN (DD), FN (DE), FN (DF),

  FN (E0), FN (E1), FN (E2), FN (E3), FN (E4), FN (E5), FN (E6), FN (E7),
  FN (E8), FN (E9), FN (EA), FN (EB), FN (EC), FN (ED), FN (EE), FN (EF),

  FN (F0), FN (F1), FN (F2), FN (F3), FN (F4), FN (F5), FN (F6), FN (F7),
  FN (F8), FN (F9), FN (FA), FN (FB), FN (FC), FN (FD), FN (FE), FN (FF)
};

/*******************************************************************************
 * 
 * INTERFACE
 * 
 ******************************************************************************/

s32 core_init ()
{
  if (f_memory) 
  {
    return 0;
  }

  if (! (f_memory = calloc (0x10000, sizeof (u08)))) 
  {
    return 0;
  }

  f_port_o [0x100] = 0;
  f_port_i [0x100] = 0;

  f_port_o [0] = 'h';
  f_port_o [1] = 'e';
  f_port_o [2] = 'l';
  f_port_o [3] = 'l';
  f_port_o [4] = 'o';
  f_port_o [5] = '!';
  f_port_o [6] = 0x0;

  return 1;
}

s32 core_quit ()
{
  if (! f_memory)
  {
    return 0;
  }

  free (f_memory);

  f_memory = 0;

  f_port_o [0x100] = 0;
  f_port_i [0x100] = 0;

  return 1;
}

#include <stdio.h>

#define REVERSE_BO(WORD) ((WORD >> 0x8) & 0xFF) + ((WORD & 0xFF) << 0x8)

nil core_dump (core* c)
{
  if (!c)
  {
    return;
  }

  printf ("AF       : %04X\n", c->AF.R16);
  printf ("-A       :   %02X\n", c->AF.R08.L);
  printf ("-F       :   %02X\n", c->AF.R08.H);
  printf ("BC       : %04X\n", c->BC.R16);
  printf ("-B       :   %02X\n", c->BC.R08.L);
  printf ("-C       :   %02X\n", c->BC.R08.H);
  printf ("DE       : %04X\n", c->DE.R16);
  printf ("-D       :   %02X\n", c->DE.R08.L);
  printf ("-E       :   %02X\n", c->DE.R08.H);
  printf ("HL       : %04X\n", c->HL.R16);
  printf ("SP       : %04X\n", c->SP.R16);
  printf ("PC       : %04X\n", c->PC.R16);

  printf ("op       :   %02X\n", c->OP);
  printf ("e        :   %02X\n", c->e );
  printf ("branch   :   %02X\n", c->branch);
  printf ("interrupt:   %02X\n", c->interrupt );
  printf ("port     :   %02X\n", c->port);
}

#define MAX_CYCLES 0x10000

s32 core_exec (core * c)
{
  s32 status = 0;
  u32 cycles = 0;

  if (! c) {
    goto end;
  }

  if (c->e) {
    goto end;
  }

  c->e = 0xFF;

  for (cycles = 0; cycles < MAX_CYCLES; cycles += f_cycle [c->branch][c->OP])
  {
    f_instruction [(c->OP = f_memory [c->PC.R16])] (c);
    c->PC.R16 += 1;
  }

  if (0) {    
    printf ("done with 0x%08X cycles\n", cycles);
    core_dump (c);  
  }

  
  c->e = 0x00;

  end:

    f_cycles += cycles;

    return status;
}

s32 core_inte (void * p, unsigned char interrupt)
{
  if (! p)
  {
    return 0;
  }

  f_instruction [0xC7 + ((interrupt & 7) * 8)] (p);
  
  return 1;
}

#include <string.h>

nil core_load (unsigned char* memory, unsigned length)
{
  if (length != 0x10000) {
    return;
  }

  memcpy (f_memory, memory, length);
}

nil core_save (unsigned char* memory, unsigned length)
{
   if (length != 0x10000) {
    return;
  }

  memcpy (memory, f_memory, length); 
}

s32 core_execute ()
{
  core c;

  memset (&c, 0, sizeof (core));

  c.SP.R16 = 0xFFFF;

  return core_exec (&c);
}

u08 core_get_port_o (u08 index)
{
  return f_port_i [index];
}

nil core_set_port_i (u08 index, u08 value)
{
  f_port_o [index] = value;
}

#include "config.h"
#include "property.h"

/* ************************************************************************
 *
 * EXTERNAL VARIABLES
 *
 * ************************************************************************/

extern wanderlust_config e_configuration;

#define CORE_GET_OUTPUT_ARG_COUNT     1
#define CORE_GET_OUTPUT_ARG_PROPERTY  1

s32 core_get_output (lua_State* L)
{
  s32 status = e_configuration.failure;

  if (! L) 
  {
    goto end;
  }

  if (lua_gettop (L) < CORE_GET_OUTPUT_ARG_COUNT)
  {
    goto end;
  }


  if (! lua_isstring (L, CORE_GET_OUTPUT_ARG_PROPERTY))
  {
    goto end;
  }

  property_create_string (
    (const s08*)lua_tostring (L, CORE_GET_OUTPUT_ARG_PROPERTY),
    (const s08*)type_secure_copy_string((const char*)f_port_o)
  );

  status = e_configuration.success;

  end:

    if (L)
    {
      lua_settop (L, 0);
    }

    return status;
}