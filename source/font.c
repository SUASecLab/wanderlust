/*
 * Wanderlust is an engine for rpgs rendered in top-down perspective, which
 * where common in the consoles of the 8- and 16-Bit Era.
 * Copyright (C) 2022 Stefan Reich
 *
 * This program is free software: you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation, either version 3 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of  MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
 * more details.
 *
 * You should have received a copy of the GNU General Public License along with
 * this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "type.h"
#include "config.h"
#include "morph.h"
#include "video.h"
#include "texture.h"
#include "task.h"
#include "font.h"

/* ************************************************************************
 *
 * EXTERNAL VARIABLES
 *
 * ************************************************************************/

extern wanderlust_config e_configuration;

/*******************************************************************************
 *
 * FILE SCOPE VARIABLES
 *
 ******************************************************************************/

static nil	* 	f_fonts			= 0;

static s32		f_initialized	= 0;

/*******************************************************************************
 *
 * FILE SCOPE FUNCTIONS
 *
 ******************************************************************************/

static nil setSymbol
(
			SDL_Surface			* 	surface,
			s32 					r,
			s32 					c,
	const 	u08					*	symbol,
			wanderlust_font		*	font
)
{
	static u08 x;
	static u08 y;

	for (y = 0; y < e_configuration.font.dimension; y++)
	{
		for (x = 0; x < e_configuration.font.dimension; x++)
		{
			((u32*)surface -> pixels) [((r + y) * surface -> w) + (c + x)] =
			symbol [y] & (0x80 >> x) ? font -> Color. fg : font -> Color.bg ;
		}
	}
}

static nil delete_font (nil * font)
{
	wanderlust_font * f = font;

	if (! f)
	{
		return;
	}

	if (f -> texture)
	{
		SDL_DestroyTexture (f -> texture);
	}

	SDL_free (f);
}

wanderlust_font * initialize_font (lua_State * L)
{
	wanderlust_font * u = 0;
	/*
	 * NAME
	 */
	if (! lua_isstring (L, 1))
	{
		return 0;
	}

	/*
	 * FOREGROUND COLOR
	 */
	if (! lua_isnumber (L, 2))
	{
		return 0;
	}

	/*
	 * BACKGROUND COLOR
	 */
	if (! lua_isnumber (L, 3))
	{
		return 0;
	}

	/*
	 * COLOR MASK R
	 */
	if (! lua_isnumber (L, 4))
	{
		return 0;
	}

	/*
	 * COLOR MASK G
	 */

	if (! lua_isnumber (L, 5))
	{
		return 0;
	}

	/*
	 * COLOR MASK B
	 */
	if (! lua_isnumber (L, 6))
	{
		return 0;
	}

	/*
	 * COLOR MASK A
	 */
	if (! lua_isnumber (L, 7))
	{
		return 0;
	}

	if (! (u = SDL_malloc (sizeof (wanderlust_font))))
	{
		return 0;
	}

	SET_U32_CONST (u -> hash,		mhash (lua_tostring (L, 1)));

	SET_U08_CONST (u -> dimension,	e_configuration.font.dimension);

	u -> texture	= 0;
	u -> Color.fg	= (u32) lua_tointeger (L, 2);
	u -> Color.bg	= (u32) lua_tointeger (L, 3);
	u -> Mask.r		= (u32) lua_tointeger (L, 4);
	u -> Mask.g		= (u32) lua_tointeger (L, 5);
	u -> Mask.b		= (u32) lua_tointeger (L, 6);
	u -> Mask.a		= (u32) lua_tointeger (L, 7);

	return u;
}

/*******************************************************************************
 *
 * TABLES
 *
 ******************************************************************************/

static const u08 data [0x100] [0x8] =
{
	/* 
		00 - 15 
	*//* 
		blank 
	*/
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	/* minimize */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00},
	/* maximize */
	{0x00, 0x7E, 0x42, 0x42, 0x42, 0x42, 0x7E, 0x00},
	/* close */
	{0x00, 0x42, 0x24, 0x18, 0x18, 0x24, 0x42, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

	/* 16 - 31 Border of MessageBox */
	/* left top */
	{0xFF, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
	/* top */
	{0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	/* right top */
	{0xFF, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01},
	/* left */
	{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
	/* origin */
	{0x81, 0x41, 0x21, 0x11, 0x09, 0x05, 0x03, 0x01},
	/* right */
	{0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01},
	/* left bottom */
	{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF},
	/* bottom */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF},
	/* right bottom */
	{0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xFF},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

	/* 
		32 - 47 
	*//* 
		space 
	*/

	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	/* ! */
	{0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x18, 0x00},
	/* " */
	{0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00},
	/* # */
	{0x66, 0x66, 0xFF, 0x66, 0xFF, 0x66, 0x66, 0x00},
	/* $ */
	{0x18, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x18, 0x00},
	/* % */
	{0x62, 0x66, 0x0C, 0x18, 0x30, 0x66, 0x46, 0x00},
	/* space */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	/* Â´ */
	{0x06, 0x0C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},
	/* ( */
	{0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00},
	/* ) */
	{0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00},
	/* * */
	{0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00},
	/* + */
	{0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00},
	/* , */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30},
	/* - */
	{0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00},
	/* . */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00},
	/*  */
	{0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x00},

	/* 
		48 - 63
	*//* 
		0 
	*/
    {0x3C, 0x66, 0x6E, 0x76, 0x66, 0x66, 0x3C, 0x00},
	/* 1 */
	{0x18, 0x18, 0x38, 0x18, 0x18, 0x18, 0x7E, 0x00},
	/* 2 */
	{0x3C, 0x66, 0x06, 0x0C, 0x30, 0x60, 0x7E, 0x00},
	/* 3 */
	{0x3C, 0x66, 0x06, 0x1C, 0x06, 0x66, 0x3C, 0x00},
	/* 4 */
	{0x06, 0x0E, 0x1E, 0x66, 0x7F, 0x06, 0x06, 0x00},
	/* 5 */
    {0x7E, 0x60, 0x7C, 0x06, 0x06, 0x66, 0x7E, 0x00},
	/* 6 */
    {0x3C, 0x66, 0x60, 0x7C, 0x66, 0x66, 0x3C, 0x00},
	/* 7 */
    {0x7E, 0x66, 0x0C, 0x18, 0x18, 0x18, 0x18, 0x00},
	/* 8 */
    {0x3C, 0x66, 0x66, 0x3C, 0x66, 0x66, 0x3C, 0x00},
	/* 9 */
    {0x3C, 0x66, 0x66, 0x3E, 0x06, 0x66, 0x3C, 0x00},
	/* : */
	{0x00, 0x00, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00},
	/* ; */
	{0x00, 0x00, 0x18, 0x00, 0x00, 0x18, 0x18, 0x30},
	/* < */
	{0x0E, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0E, 0x00},
	/* = */
	{0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00, 0x00},
	/* > */
	{0x70, 0x18, 0x0C, 0x06, 0x0C, 0x18, 0x70, 0x00},
	/* ? */
	{0x3C, 0x66, 0x06, 0x0C, 0x18, 0x00, 0x18, 0x00},

	/* 
		64 - 79 
	*//* 
		@ 
	*/
	{0x3C, 0x66, 0x6E, 0x6C, 0x60, 0x62, 0x3C, 0x00},
	/* A */
	{0x18, 0x3C, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00},
	/* B */
	{0x7C, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x7C, 0x00},
	/* C */
	{0x3C, 0x66, 0x60, 0x60, 0x60, 0x66, 0x3C, 0x00},
	/* D */
	{0x78, 0x6C, 0x66, 0x66, 0x66, 0x6C, 0x78, 0x00},
	/* E */
	{0x7E, 0x60, 0x60, 0x78, 0x60, 0x60, 0x7E, 0x00},
	/* F */
	{0x7E, 0x60, 0x60, 0x78, 0x60, 0x60, 0x60, 0x00},
	/* G */
	{0x3C, 0x66, 0x60, 0x6E, 0x66, 0x66, 0x3C, 0x00},
	/* H */
	{0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00},
	/* I */
	{0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00},
	/* J */
	{0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x6C, 0x38, 0x00},
	/* K */
	{0x66, 0x6C, 0x78, 0x70, 0x78, 0x6C, 0x66, 0x00},
	/* L */
	{0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x00},
	/* M */
	{0x63, 0x77, 0x7F, 0x6B, 0x63, 0x63, 0x63, 0x00},
	/* N */
	{0x66, 0x76, 0x7E, 0x7E, 0x6E, 0x66, 0x66, 0x00},
	/* O */
	{0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00},

	/* 
		80 - 95 
	*//* 
		P 
	*/

	{0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x60, 0x00},
	/* Q */
	{0x3C, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x0E, 0x00},
	/* R */
	{0x7C, 0x66, 0x66, 0x7C, 0x78, 0x6C, 0x66, 0x00},
	/* S */
	{0x3C, 0x66, 0x60, 0x3C, 0x06, 0x66, 0x3C, 0x00},
	/* T */
	{0x7C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},
	/* U */
	{0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00},
	/* V */
	{0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00},
	/* W */
	{0x63, 0x63, 0x63, 0x6B, 0x7F, 0x77, 0x63, 0x00},
	/* X */
	{0x66, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x66, 0x00},
	/* Y */
	{0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x00},
	/* Z */
	{0x7E, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x7E, 0x00},
	/* [ */
	{0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00},
	/* BACKSLASH */
	{0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x00},
	/* ] */
	{0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00},
	/* ^ */
	{0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00},
	/* _  */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x7E},

	/* 
		96 - 111 
	*//* 
		space 
	*/

	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	/* a */
	{0x00, 0x00, 0x3C, 0x06, 0x3E, 0x66, 0x3E, 0x00},
	/* b */
	{0x00, 0x60, 0x60, 0x7C, 0x66, 0x66, 0x7C, 0x00},
	/* c */
	{0x00, 0x00, 0x3C, 0x60, 0x60, 0x60, 0x3C, 0x00},
	/* d */
	{0x00, 0x06, 0x06, 0x3E, 0x66, 0x66, 0x3E, 0x00},
	/* e */
	{0x00, 0x00, 0x3C, 0x66, 0x7E, 0x60, 0x3C, 0x00},
	/* f */
	{0x00, 0x0E, 0x18, 0x3E, 0x18, 0x18, 0x18, 0x00},
	/* g */
	{0x00, 0x00, 0x3E, 0x66, 0x66, 0x3E, 0x06, 0x7C},
	/* h */
	{0x00, 0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x00},
	/* i */
	{0x00, 0x18, 0x00, 0x38, 0x18, 0x18, 0x3C, 0x00},
	/* j */
	{0x00, 0x06, 0x00, 0x06, 0x06, 0x06, 0x06, 0x3C},
	/* k */
	{0x00, 0x60, 0x60, 0x6C, 0x78, 0x6C, 0x66, 0x00},
	/* l */
	{0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00},
	/* m */
	{0x00, 0x00, 0x66, 0x7F, 0x7F, 0x6B, 0x63, 0x00},
	/* n */
	{0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x00},
	/* o */
	{0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3C, 0x00},

	/* 
		112 - 127  
	*//* 
		p 
	*/

	{0x00, 0x00, 0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60},
	/* q */
	{0x00, 0x00, 0x3E, 0x66, 0x66, 0x3E, 0x06, 0x06},
	/* r */
	{0x00, 0x00, 0x7C, 0x66, 0x60, 0x60, 0x60, 0x00},
	/* s */
	{0x00, 0x00, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x00},
	/* t */
	{0x00, 0x18, 0x7E, 0x18, 0x18, 0x18, 0x0E, 0x00},
	/* u */
	{0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x00},
	/* v */
	{0x00, 0x00, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00},
	/* w */
	{0x00, 0x00, 0x63, 0x6B, 0x7F, 0x3E, 0x36, 0x00},
	/* x */
	{0x00, 0x00, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x00},
	/* y */
	{0x00, 0x00, 0x66, 0x66, 0x66, 0x3E, 0x0C, 0x78},
	/* z */
	{0x00, 0x00, 0x7E, 0x0C, 0x18, 0x30, 0x7E, 0x00},
	/* cross */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	/* left half chess pattern */
	{0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},
	/* centered vertical line */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	/* chess pattern */
	{0x00, 0x01, 0x03, 0x06, 0x8C, 0xD8, 0x70, 0x20},
	/* left to right diagonal lines */
	{0x41, 0x22, 0x14, 0x08, 0x14, 0x22, 0x41, 0x80},

	/* 
		128 - 143 
	*/

	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

	/* 
		144 - 159 
	*/

	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

	/* 
		160 - 175 
	*/

	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

	/* 
		176 - 191 
	*/

	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

	/* 
		192 - 207 
	*/

	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

	/* 
		208 - 223 
	*/

	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

	/* 
		224 - 239 
	*/

	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

	/* 
		240 - 255 
	*/
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
};

/*******************************************************************************
 *
 * COMPARISON
 *
 ******************************************************************************/

u08 font_compare_by_hash (nil * item, nil * value)
{
	return ((wanderlust_font *) item) -> hash == *((u32 *) value);
}

/*******************************************************************************
 *
 * TASKS
 *
 ******************************************************************************/

static nil task_font_create (nil * arg)
{
	u32						i = 0;
	u32						j = 0;
	SDL_Surface 		*	x = 0;
	wanderlust_font 	*	u = 0;

	if (! (u = arg))
	{
		return;
	}

	x = SDL_CreateRGBSurface
	(
		0,
		u->dimension * e_configuration.font.columns,
		u->dimension * e_configuration.font.rows,
		e_configuration.font.depth,
		u->Mask.r,
		u->Mask.g,
		u->Mask.b,
		u->Mask.a
	);

	if (! x)
	{
		delete_font (x); return;
	}

	for (j = 0; j < e_configuration.font.rows; j++)
	{
		for (i = 0; i < e_configuration.font.columns; i++)
		{
			setSymbol
			(
				x,
				u->dimension * j,
				u->dimension * i,
				data [j * e_configuration.font.columns + i],
				u
			);
		}
	}

	u -> texture = video_create_texture_from_surface (x);

	SDL_FreeSurface (x);

	if (! u -> texture)
	{
		delete_font (u); return;
	}

	madd (f_fonts, u);
}

/*******************************************************************************
 *
 * INTERFACE
 *
 ******************************************************************************/

s08 font_initialize (lua_State* L)
{
	if (f_initialized == e_configuration.success)
	{
		return f_initialized;
	}

	f_initialized = e_configuration.success;

	if (! L)
	{
		goto FAILURE;
	}

	lua_register (L, WL_CREATE_FONT, font_create);

	if (! (f_fonts = mcreate (M_SINGLE_LINKED_LIST)))
	{
		goto FAILURE;
	}

	task_register (TASK_FONT_CREATE, task_font_create);

	return e_configuration.success;

	FAILURE:

		return e_configuration.failure;
}

nil font_terminate ()
{
	if (f_initialized == e_configuration.failure)
	{
		return;
	}

	if (f_fonts)
	{
		f_fonts = mdelete (f_fonts, delete_font);
	}

	f_initialized = e_configuration.failure;
}

wanderlust_font * font_get (u32 hash)
{
	if (f_initialized == e_configuration.failure)
	{
		goto FAILURE;
	}

	return mfind (f_fonts, &hash, font_compare_by_hash, 0);

	FAILURE:

		return e_configuration.null;
}

s32 font_create (lua_State * L)
{
	wanderlust_font * u = 0;

	if (! L)
	{
		goto FAILURE;
	}

	if (f_initialized == e_configuration.failure)
	{
		goto FAILURE;
	}

	if (lua_gettop (L) < 7)
	{
		goto FAILURE;
	}

	if (! (u = initialize_font (L)))
	{
		goto FAILURE;
	}

	task_enqueue (TASK_FONT_CREATE, u);

	lua_settop (L, e_configuration.zero);

	return e_configuration.success;

	FAILURE:

		if (L)
		{			
			lua_settop (L, e_configuration.zero);
		}

		return e_configuration.failure;
}
